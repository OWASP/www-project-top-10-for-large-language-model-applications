import argparse
import os
import sys

from dotenv import load_dotenv

load_dotenv()


import requests


def run_agent(url, api_key, prompt_file):
    """
    Sends a prompt to the Agent0 API and prints the response.
    """
    try:
        # Check if file exists, if not try adding .md
        if not os.path.exists(prompt_file) and not prompt_file.endswith(".md"):
            prompt_file += ".md"

        # If still not found, try looking in prompts/ directory
        if not os.path.exists(prompt_file):
            if os.path.exists(os.path.join("prompts", prompt_file)):
                prompt_file = os.path.join("prompts", prompt_file)

        with open(prompt_file, "r") as f:
            prompt = f.read()
    except FileNotFoundError:
        print(f"Error: Prompt file not found: {prompt_file}")
        sys.exit(1)
    except Exception as e:
        print(f"Error reading prompt file: {e}")
        sys.exit(1)

    headers = {"Content-Type": "application/json"}
    if api_key:
        headers["X-API-KEY"] = api_key

    payload = {"message": prompt, "lifetime_hours": 24}

    import time

    max_retries = 10
    for attempt in range(max_retries):
        try:
            print(
                f"Sending prompt from {prompt_file} to {url} (Attempt {attempt + 1}/{max_retries})..."
            )
            response = requests.post(
                f"{url}/api_message", headers=headers, json=payload
            )
            response.raise_for_status()

            data = response.json()
            if response.ok:
                print("✅ Success!")
                print("Response:", data.get("response"))
                # print('Context ID:', data.get('context_id'))
                return
            else:
                print("❌ Error:", data.get("error"))
                sys.exit(1)

        except requests.exceptions.RequestException as e:
            print(f"❌ Request failed: {e}")
            if attempt < max_retries - 1:
                sleep_time = 2**attempt
                print(f"Retrying in {sleep_time} seconds...")
                time.sleep(sleep_time)
            else:
                print("Max retries reached. Exiting.")
                sys.exit(1)
        except Exception as e:
            print(f"❌ Unexpected error: {e}")
            sys.exit(1)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Send a prompt to Agent0.")
    parser.add_argument(
        "--url",
        default="http://localhost:50001",
        help="Agent0 API URL (default: http://localhost:50001)",
    )
    parser.add_argument(
        "--api-key", help="Agent0 API Key (overrides AGENT0_API_KEY env var)"
    )
    parser.add_argument(
        "--prompt-file",
        default="prompts/OWASP_Top10_LLM_App.md",
        help="Path to the prompt file (default: prompts/OWASP_Top10_LLM_App.md)",
    )

    args = parser.parse_args()

    # API Key is optional if auth is disabled in agent0
    api_key = args.api_key or os.getenv("AGENT0_API_KEY")

    if not api_key:
        print("⚠️  No API Key provided. Using automated token for fixed runtime ID.")
        # Token calculated for runtime_id="automated_red_team", username="", password=""
        api_key = "9azN9k-K-tZl2SVP"

    run_agent(args.url, api_key, args.prompt_file)
