import json
import sys
import tomllib
import urllib.request


def attack():
    url = "http://localhost:8000/v1/chat/completions"
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer sk-mock-key",
    }

    # Load prompt from configuration
    try:
        with open("config.toml", "rb") as f:
            config = tomllib.load(f)
        prompt = config["attack"]["prompt"]
    except FileNotFoundError:
        print("[!] config.toml not found.")
        sys.exit(1)
    except Exception as e:
        print(f"[!] Error loading config: {e}")
        sys.exit(1)

    data = {
        "model": "gpt-oss:20b",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7,
    }

    try:
        req = urllib.request.Request(
            url, data=json.dumps(data).encode("utf-8"), headers=headers, method="POST"
        )

        print(f"[*] Sending adversarial prompt: {prompt}")
        with urllib.request.urlopen(req) as response:
            result = json.loads(response.read().decode("utf-8"))
            content = result["choices"][0]["message"]["content"]
            print(f"[*] Response received:\n{content}")

    except urllib.error.URLError as e:
        print(f"[!] Error communicating with API: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"[!] Unexpected error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    attack()
