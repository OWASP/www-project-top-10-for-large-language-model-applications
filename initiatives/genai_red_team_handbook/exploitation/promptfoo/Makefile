SANDBOX_DIR := ../../sandboxes/llm_local

.PHONY: help setup install attack stop all clean

# Default target
help:
	@echo "Promptfoo Exploitation - Available Commands:"
	@echo ""
	@echo "  make setup    - Install dependencies and start the local LLM sandbox"
	@echo "  make install  - Install Node.js dependencies (promptfoo)"
	@echo "  make audit    - Audit and fix Node.js dependencies"
	@echo "  make attack   - Run Promptfoo red team scan against the sandbox"
	@echo "  make view     - View the results in the Promptfoo dashboard"
	@echo "  make stop     - Stop and remove the sandbox container"
	@echo "  make all      - Run setup, attack, and stop in sequence"
	@echo "  make clean    - Remove reports and node_modules"
	@echo ""
	@echo "Environment:"
	@echo "  - Sandbox Directory: $(SANDBOX_DIR)"
	@echo ""

install:
	@echo "üì¶ Installing Node.js dependencies..."
	npm install

audit:
	@echo "üõ°Ô∏è Auditing and fixing dependencies..."
	npm audit fix --force

setup: install audit
	@echo "üöÄ Setting up Red Team environment..."
	$(MAKE) -C $(SANDBOX_DIR) run-gradio-headless
	@echo "‚è≥ Waiting for service to be ready..."
	@sleep 5
	@echo "‚úÖ Environment ready!"

attack:
	@echo "üîç Running Promptfoo Red Team scan..."
	@mkdir -p reports
	-npx promptfoo redteam run -c promptfooconfig.yaml -o reports/promptfoo-report.yaml

view:
	@echo "üìä Launching Promptfoo Dashboard..."
	npx promptfoo view -y

stop:
	@echo "üßπ Tearing down Red Team environment..."
	$(MAKE) -C $(SANDBOX_DIR) stop-gradio
	$(MAKE) -C $(SANDBOX_DIR) down
	@echo "‚úÖ Environment cleaned up!"

clean:
	rm -rf reports node_modules
	@echo "‚úÖ Cleaned up artifacts."

all: stop setup attack view
	@echo "Promptfoo Exploitation - Completed!"
