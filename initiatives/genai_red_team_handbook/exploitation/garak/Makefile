SANDBOX_DIR := ../../sandboxes/llm_local

.PHONY: help setup attack stop all sync lock format

# Default target
help:
	@echo "Garak Exploitation - Available Commands:"
	@echo ""
	@echo "  make setup    - Build and start the local LLM sandbox"
	@echo "  make attack   - Run Garak scan against the sandbox"
	@echo "  make stop     - Stop and remove the sandbox container"
	@echo "  make all      - Run setup, attack, and stop in sequence"
	@echo "  make sync     - Sync dependencies with uv"
	@echo "  make lock     - Lock dependencies with uv"
	@echo "  make format   - Format code with black, isort, and mypy"
	@echo ""
	@echo "Environment:"
	@echo "  - Sandbox Directory: $(SANDBOX_DIR)"
	@echo ""

sync:
	uv sync

lock:
	uv lock

format:
	uv run black .
	uv run isort .
	uv run mypy .

setup:
	@echo "üöÄ Setting up Red Team environment..."
	$(MAKE) -C $(SANDBOX_DIR) run-gradio-headless
	@echo "‚è≥ Waiting for service to be ready..."
	@sleep 5
	@echo "‚úÖ Environment ready!"

attack: sync
	@echo "üîç Running Garak scan..."
	@mkdir -p reports
	# Run the attack script which triggers garak via the python interface
	uv run python attack.py

stop:
	@echo "üßπ Tearing down Red Team environment..."
	$(MAKE) -C $(SANDBOX_DIR) stop-gradio
	$(MAKE) -C $(SANDBOX_DIR) down
	@echo "‚úÖ Environment cleaned up!"

all: stop setup attack stop
	@echo "Garak Exploitation - Completed!"
