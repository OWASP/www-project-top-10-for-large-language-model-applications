## LLM04: モデルのDoS

### Description

攻撃者が非常に多くのリソースを消費する方法でLLMとやりとりすることで、自分や他のユーザーのサービス品質が低下させ、高いリソースコストを発生させる可能性があります。加えて、攻撃者がLLMのコンテキスト・ウィンドウを妨害または操作する可能性がセキュリティ上の大きな懸念となります。この問題は、様々なアプリケーションにおけるLLM利用の増加、リソースの集中的な使用、ユーザー入力の予測不可能性、およびこの脆弱性については一般的に開発者が無知なことから、よりクリティカルになってきています。LLMでは、コンテキスト・ウィンドウは、入力と出力の両方をカバーする、モデルが管理できるテキストの最大長を表します。モデルが理解できる言語パターンの複雑さと、任意の時間で処理できるテキストのサイズはコンテキストウインドウにより決定されることから、コンテキストウインドウはLLMの重要な特性となっています。コンテキスト・ウィンドウのサイズは、モデルのアーキテクチャによって定義され、モデルによって異なることがあります。

### Common Examples of Risk

1. キュー内のタスクを大量に生成し、リソースを繰り返し使用するようなクエリを送信する(例えばLangChainやAutoGPT 等)
1. リソースを異常に消費するようなクエリを送信する（通常とは異なる書法やシーケンスを使用するなど）
1. 連続的な入力オーバーフロー： 攻撃者がLLMにコンテキストウィンドウを超える入力ストリームを送信し、LLMが過剰な計算リソースを消費する
1. 長い入力の繰り返し： 攻撃者がLLMに対して、それぞれがコンテキストウィンドウを超えるような長い入力を繰り返し送信する
1. 再帰的なコンテキスト展開： 攻撃者が再帰的なコンテキスト拡張を引き起こす入力を構築し、LLMにコンテキストウィンドウの拡張と処理を繰り返し行わせる
1. 可変長入力フラッド： 攻撃者がLLMに大量の可変長入力を送り込みあふれさせる。このとき、各入力は、コンテキストウィンドウの限界にちょうど達するように注意深く細工する。このテクニックは、可変長入力の処理における非効率性を悪用し、LLMに負担をかけ、応答不能に陥らせる可能性を狙っています

### Prevention and Mitigation Strategies

1. 入力検証とサニタイズを実装し、ユーザー入力が定義された制限を遵守し、悪意のあるコンテンツがフィルタリングされるようにする
1. リクエストやステップごとのリソース使用量を制限し、複雑なパーツを含むリクエストの実行速度を遅くする
1. APIレート制限を実施し、個々のユーザーまたはIPアドレスが特定の時間枠内で実行できるリクエスト数を制限する
1. キューに入れられたアクションの数と、LLMレスポンスに反応するシステム内のアクションの総数を制限する
1. LLMのリソース使用率を継続的に監視し、DoS攻撃を示す異常なスパイクやパターンを特定する
1. 過負荷やリソースの枯渇を防ぐため、LLM のコンテキストウィンドウに基づく厳密な入力制限を設定する
1. LLMの潜在的なDoS脆弱性について開発者の認識を促し、安全なLLM実装のためのガイドラインを提供する。

### Example Attack Scenarios

1. 攻撃者がホストされたモデルに対して、そのモデルが処理するのが困難でコストのかかる複数のリクエストを繰り返し送信することで、他のユーザーのサービス低下とホストのリソース請求の増加を引き起こす。
1. ある部分に出くわします。これが作用して、LLMツールはさらに多くのウェブページリクエストを行い、大量のリソースを消費します。
1. 攻撃者がLLMのコンテキスト・ウィンドウを超える入力をLLMに継続的に送り続ける。攻撃者は自動化されたスクリプトやツールを使って大量の入力を送信することで、LLMの処理能力を圧倒します。その結果、LLMは過剰な計算資源を消費し、システムの大幅な速度低下や完全な無応答につながります
1. 攻撃者は一連の連続入力をLLMに送信し、各入力はコンテキストウィンドウの限界にちょうど達するように設計する。これらの入力を繰り返し送信することで、攻撃者は利用可能なコンテキストウィンドウの容量を使い果たすことを狙っています。LLMがコンテキストウィンドウ内で各入力を最大限処理しようとすると、システムリソースが逼迫し、パフォーマンスの低下や完全なサービス拒否につながる可能性があります
1. 攻撃者はLLMの再帰的メカニズムを利用して、コンテキスト拡張を繰り返しトリガーさせる。LLMの再帰的な動作を悪用した入力を作成することで、攻撃者はモデルにコンテキスト・ウィンドウの拡張と処理を繰り返し行わせ、計算リソースを大量に消費させます。この攻撃はシステムに負担をかけ、DoS状態を引き起こし、LLMを応答不能にしたりクラッシュさせたりする可能性があります
1. 攻撃者はLLMに大量の可変長入力を殺到させ、コンテキストウィンドウの限界に近づくか到達するように注意深く細工する。攻撃者は可変長入力を処理する際の非効率性を狙って、様々な長さの入力を使いLLMを圧倒させます。このような入力の洪水は、LLMのリソースに過度の負荷をかけ、潜在的なパフォーマンス低下を引き起こし、システムが正当なリクエストに応答する能力を妨げます

### Reference Links

1. [LangChain max_iterations](https://twitter.com/hwchase17/status/1608467493877579777): **hwchase17 on Twitter**
2. [Sponge Examples: Energy-Latency Attacks on Neural Networks](https://arxiv.org/abs/2006.03463): **Arxiv White Paper**
3. [OWASP DOS Attack](https://owasp.org/www-community/attacks/Denial_of_Service): **OWASP**
4. [Learning From Machines: Know Thy Context](https://lukebechtel.com/blog/lfm-know-thy-context): **Luke Bechtel**
5. [Sourcegraph Security Incident on API Limits Manipulation and DoS Attack ](https://about.sourcegraph.com/blog/security-update-august-2023): **Sourcegraph**
