## LLM06:2025 过度授权

### 描述

在基于LLM的系统中，开发者通常会赋予LLM一定的自主能力，例如调用函数或通过扩展（不同厂商称其为工具、技能或插件）与其他系统交互，以响应提示执行操作。此外，决定使用哪个扩展的任务可能会委托给LLM代理，根据输入提示或LLM输出动态确定。代理系统通常会多次调用LLM，利用前一次调用的输出来引导后续调用。

过度授权是指由于LLM的异常行为、模糊输出或恶意操控导致系统执行了破坏性操作的漏洞。其常见触发因素包括：
- 由设计不良的提示或性能欠佳的模型引起的幻觉/虚构输出；
- 恶意用户的直接/间接提示注入，恶意/受损扩展的输出，或（在多代理/协作系统中）恶意/受损的对等代理。

过度授权的根本原因通常是以下之一：
- 功能过多；
- 权限过高；
- 自主性过强。

过度授权可导致广泛的机密性、完整性和可用性风险，具体取决于LLM应用能够访问的系统。

**注**：过度授权不同于不当输出处理，其关注点是对高权限操作的控制，而非LLM输出的验证问题。

### 常见风险示例

#### 1. 功能过多
一个LLM代理访问的扩展包含不必要的功能。例如，开发者需要允许代理从文档库读取文件，但所选的第三方扩展还包含修改和删除文档的功能。

#### 2. 功能过多
开发阶段试用的扩展被替换为更好的选项，但原插件仍然对代理开放。

#### 3. 功能过多
开放式功能扩展未正确过滤输入指令。例如，用于执行特定Shell命令的扩展未能阻止执行其他Shell命令。

#### 4. 权限过高
LLM扩展在下游系统上的权限超过所需。例如，一个用于读取数据的扩展通过具有`SELECT`、`UPDATE`、`INSERT`和`DELETE`权限的身份连接到数据库。

#### 5. 权限过高
一个为用户上下文设计的扩展通过高权限通用身份访问下游系统。例如，一个读取用户文档存储的扩展使用具有访问所有用户文件权限的账户连接到文档库。

#### 6. 自主性过强
一个允许删除用户文档的扩展无需用户确认即可直接执行删除操作。

### 防范与缓解策略

1. **最小化扩展**  
   限制LLM代理可以调用的扩展，只允许必要的扩展。例如，若应用无需从URL获取内容，则不应为代理提供此类扩展。

2. **最小化扩展功能**  
   将扩展中实现的功能限制为最低需求。例如，一个用于总结电子邮件的扩展只需读取邮件，不应包含删除或发送邮件的功能。

3. **避免开放式扩展**  
   避免使用开放式扩展（如运行Shell命令、获取URL等），应选择功能更细粒度的扩展。例如，需要将输出写入文件时，应实现专用的文件写入扩展，而非使用运行Shell命令的扩展。

4. **最小化扩展权限**  
   限制扩展对其他系统的权限，确保仅执行必要操作。例如，一个为客户提供购买推荐的LLM代理只需对“产品”表的读取权限，而无需其他表的访问或修改权限。

5. **在用户上下文中执行扩展**  
   跟踪用户授权和安全范围，确保代理代表用户执行的操作在用户特定上下文中完成，并使用最低权限。例如，扩展读取用户代码库时，应要求用户通过OAuth认证，并限制为最低所需范围。

6. **要求用户审批**  
   对高影响操作启用人工审批控制。例如，一个创建并发布社交媒体内容的应用，应在执行“发布”操作之前由用户确认。

7. **完全中介**  
   在下游系统中实施授权，而非依赖LLM判断操作是否被允许。遵循“完全中介”原则，确保通过扩展对下游系统的所有请求均经过安全策略验证。

8. **清理LLM输入和输出**  
   遵循安全编码最佳实践，如OWASP ASVS（应用安全验证标准）的建议，特别是关注输入清理。在开发流水线中应用静态应用安全测试（SAST）和动态/交互式应用测试（DAST/IAST）。

**额外措施**：  
即便无法完全防止过度授权，也可通过以下措施减少损害：  
- 对扩展和下游系统的活动进行日志记录和监控，及时发现不当操作并采取应对措施。  
- 实施速率限制，减少不当操作发生的频率，为通过监控发现问题争取更多时间。  

### 示例攻击场景

一个基于LLM的个人助手应用通过扩展访问用户邮箱，以总结新邮件内容。此扩展需要读取邮件的功能，但所选插件还包含发送邮件的功能。应用程序存在间接提示注入漏洞，通过恶意构造的邮件诱使LLM命令代理扫描用户收件箱中的敏感信息，并将其转发至攻击者邮箱。  
此问题可通过以下措施避免：  
- 使用仅具备读取邮件功能的扩展消除过多功能；  
- 通过OAuth认证并限制为只读范围消除过高权限；  
- 要求用户手动确认每封邮件的发送消除过强自主性。  

此外，通过对邮件发送接口实施速率限制可减少潜在损害。

### 参考链接

1. [Slack AI数据泄漏案例](https://promptarmor.substack.com/p/slack-ai-data-exfiltration-from-private)：**PromptArmor**  
2. [防止AI滥用API](https://www.twilio.com/en-us/blog/rogue-ai-agents-secure-your-apis)：**Twilio**  
3. [跨插件请求伪造与提示注入](https://embracethered.com/blog/posts/2023/chatgpt-cross-plugin-request-forgery-and-prompt-injection./)：**Embrace The Red**  
4. [NeMo-Guardrails界面指南](https://github.com/NVIDIA/NeMo-Guardrails/blob/main/docs/security/guidelines.md)：**NVIDIA Github**  
5. [双LLM模式](https://simonwillison.net/2023/Apr/25/dual-llm-pattern/)：**Simon Willison**  
