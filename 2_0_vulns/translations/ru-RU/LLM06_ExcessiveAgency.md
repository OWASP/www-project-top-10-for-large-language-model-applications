## LLM06:2025 Чрезмерная агентность

### Описание

Система на базе LLM часто получает определённую степень агентности, предоставляемой разработчиком — способность вызывать функции или взаимодействовать с другими системами через расширения (иногда называемые инструментами, навыками или плагинами в зависимости от поставщика), чтобы выполнять действия в ответ на запрос. Решение о том, какое расширение вызывать, может быть делегировано агенту LLM для динамического выбора на основе входного запроса или результата работы LLM. Агентные системы обычно делают повторяющиеся вызовы к LLM, используя результаты предыдущих вызовов для корректировки и направления следующих.

Чрезмерная агентность — это уязвимость, которая позволяет выполнить вредоносные действия в ответ на неожиданные, неоднозначные или манипулированные выходные данные от LLM, независимо от того, что вызывает сбой LLM. Распространённые триггеры включают:
- галлюцинации, вызванные плохо сконструированными или неэффективными запросами,
- прямая или косвенная Prompt Injection от злоумышленника, предыдущий вызов вредоносного или скомпрометированного расширения или (в многозадачных/коллаборативных системах) скомпрометированный агент.

Коренная причина чрезмерной агентности обычно включает в себя одно или несколько из:
- Избыточная функциональность,
- Избыточные права доступа,
- Избыточная автономность.

Чрезмерная агентность (Excessive Agency) может привести к широкому спектру последствий, затрагивающих конфиденциальность, целостность и доступность, в зависимости от того, с какими системами может взаимодействовать приложение на основе LLM.

Примечание: Чрезмерная агентность отличается от некорректной обработки выходных данных (Insecure Output Handling), которая связана с недостаточной проверкой результатов работы LLM.

### Распространенные примеры рисков

#### 1. Избыточная функциональность
  Агент LLM имеет доступ к расширениям, которые включают функции, не требующиеся для предполагаемой работы системы. Например, разработчику необходимо предоставить агенту LLM возможность читать документы из репозитория, но выбранное стороннее расширение также включает функции для изменения и удаления документов.
#### 2. Избыточная функциональность
  Расширение могло быть протестировано на этапе разработки и заменено более подходящей альтернативой, но изначальный плагин остаётся доступным для агента LLM.
#### 3. Избыточная функциональность
  Плагин LLM с широким спектром возможностей не фильтрует инструкции должным образом для ограничения команд, которые не требуются для работы приложения. Например, расширение, предназначенное для выполнения одной конкретной команды в терминале, не предотвращает выполнение других команд оболочки.
#### 4. Избыточные права доступа
  Расширение LLM имеет доступ к системам на более высоком уровне, чем это необходимо для работы приложения. Например, расширение, предназначенное для чтения данных, подключается к серверу базы данных с использованием учётной записи, которая имеет права не только на SELECT, но также на UPDATE, INSERT и DELETE.
#### 5. Избыточные права доступа
  Расширение LLM, предназначенное для выполнения операций от имени конкретного пользователя, получает доступ к системам с использованием общей высокопривилегированной учётной записи. Например, расширение для чтения документов текущего пользователя подключается к репозиторию документов через учётную запись с доступом к файлам всех пользователей.
#### 6. Избыточная автономность
  Приложение или расширение на основе LLM не выполняет независимую проверку и подтверждение действий с серьёзными последствиями. Например, расширение, позволяющее удалять документы пользователя, выполняет удаление без подтверждения со стороны пользователя.

### Стратегии предотвращения и смягчения последствий

Следующие меры могут предотвратить чрезмерную агентность

#### 1. Минимизировать количество расширений
  Ограничьте число расширений, которые могут вызывать агенты LLM, только необходимыми для работы системы. Например, если система на базе LLM не требует доступа к содержимому URL, такое расширение не должно быть доступно.
#### 2. Минимизировать функциональность расширений
  Ограничьте число расширений, которые могут вызывать агенты LLM, только необходимыми для работы системы. Например, если система на базе LLM не требует доступа к содержимому URL, такое расширение не должно быть доступно.
#### 3. Избегать использования неограниченных расширений
  Избегайте использования расширений с открытой функциональностью (например, выполнение shell-команд, загрузка URL и т. д.) там, где это возможно, и используйте расширения с более узкой и конкретной функциональностью. Например, если приложению на основе LLM нужно записать выходные данные в файл, реализация через расширение для выполнения shell-команды создает значительный риск (можно выполнить любую другую shell-команду). Более безопасной альтернативой является создание конкретного расширения для записи в файл, которое реализует только эту функцию.
#### 4. Минимизировать привилегии расширений
  Ограничьте привилегии, предоставляемые расширениям LLM, до минимально необходимого уровня, чтобы уменьшить риск нежелательных действий. Например, агент LLM, использующий базу данных продуктов для рекомендаций клиентам, может нуждаться только в доступе на чтение таблицы "products". Он не должен иметь доступ к другим таблицам или возможность добавлять, изменять или удалять записи. Это можно обеспечить, применяя соответствующие разрешения в базе данных для идентификации, используемой расширением LLM.
#### 5. Выполнение в контексте пользователя
  Отслеживайте авторизацию пользователя и безопасность, чтобы убедиться, что действия, выполняемые от имени пользователя, выполняются в системах с минимально необходимыми привилегиями. Например, расширение LLM, которое читает репозиторий кода пользователя, должно требовать аутентификацию через OAuth с минимально необходимыми разрешениями.
#### 6. Требовать подтверждения от пользователя
  Используйте механизм "человек в цикле" (human-in-the-loop), чтобы требовать подтверждения человеком действий с высоким риском до их выполнения. Это может быть реализовано как в сторонней системе (вне контекста LLM-приложения), так и внутри самого расширения LLM. Например, приложение на основе LLM, создающее и публикующее контент в социальных сетях от имени пользователя, должно включать рутину подтверждения пользователя в расширении, которое выполняет операцию "публикация".
#### 7. Принцип полной медиации
  Реализуйте авторизацию в системах downstream вместо того, чтобы полагаться на решения LLM о допустимости действий. Соблюдайте принцип полной медиации, чтобы все запросы к downstream-системам через расширения проверялись в соответствии с политиками безопасности.
#### 8. Очистка входных и выходных данных LLM
  Следуйте передовым практикам безопасной разработки ПО, таким как рекомендации OWASP в ASVS (Application Security Verification Standard), с особым вниманием к очистке данных. Используйте статический анализ безопасности приложений (SAST) и динамическое и интерактивное тестирование приложений (DAST, IAST) в процессах разработки.

Перечисленные меры не предотвратят проблему избыточной автономии, но могут ограничить уровень наносимого ущерба:

- Ведение журналов и мониторинг активности расширений LLM и связанных систем, чтобы выявлять нежелательные действия и своевременно на них реагировать.
- Реализация ограничения скорости (rate-limiting) для уменьшения количества нежелательных действий, которые могут быть выполнены за определённый период времени, что увеличивает шанс обнаружить такие действия через мониторинг до того, как будет нанесён значительный ущерб.

### Примерные сценарии атак

Приложение на основе LLM, выполняющее функции персонального помощника, получает доступ к почтовому ящику пользователя через расширение для обобщения содержимого входящих писем. Для выполнения этой функции расширение требует возможности читать сообщения, однако выбранный разработчиком системы плагин также включает функции отправки сообщений. Дополнительно приложение уязвимо к атакам косвенной Prompt Injection, при которых вредоносное входящее письмо может обмануть LLM и заставить агента просканировать почтовый ящик пользователя на предмет конфиденциальной информации и переслать ее на адрес электронной почты злоумышленника.

Этого можно избежать, предприняв следующие меры:

- устранение избыточной функциональности за счет использования расширения, которое реализует только возможность чтения почты,
- устранение избыточных привилегий за счет аутентификации в почтовом сервисе пользователя через OAuth-сессию с доступом только на чтение, и/или
- устранение избыточной автономии за счет необходимости ручного подтверждения пользователем отправки каждого письма, подготовленного расширением LLM.

Альтернативно, для уменьшения ущерба можно реализовать ограничение скорости (rate limiting) для интерфейса отправки почты.

### Ссылки на источники

1. [Slack AI data exfil from private channels](https://promptarmor.substack.com/p/slack-ai-data-exfiltration-from-private): **PromptArmor**
2. [Rogue Agents: Stop AI From Misusing Your APIs](https://www.twilio.com/en-us/blog/rogue-ai-agents-secure-your-apis): **Twilio**
3. [Embrace the Red: Confused Deputy Problem](https://embracethered.com/blog/posts/2023/chatgpt-cross-plugin-request-forgery-and-prompt-injection./): **Embrace The Red**
4. [NeMo-Guardrails: Interface guidelines](https://github.com/NVIDIA/NeMo-Guardrails/blob/main/docs/security/guidelines.md): **NVIDIA Github**
5. [Simon Willison: Dual LLM Pattern](https://simonwillison.net/2023/Apr/25/dual-llm-pattern/): **Simon Willison**
